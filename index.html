<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="format-detection" content="telephone=no,date=no,address=no,email=no" />
  <title>电子校园卡</title>
  <style>
    :root{
      --bg:#f2f4f6;
      --card:#fff;
      --line:#e7ebf0;
      --text:#222;
      --muted:#8b8f97;
      --green1:#79c83b;
      --green2:#66b92c;
      --shadow: 0 10px 26px rgba(0,0,0,.08);
      --radius:16px;

      --vw: min(100vw, 430px);
      --u: min(1, calc(var(--vw) / 390)); /* 宽屏不再放大 */
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    body{-webkit-text-size-adjust:100%;}

    .app{width:var(--vw);margin:0 auto;padding-bottom:calc(92px * var(--u));}

    .topbar{height:calc(56px * var(--u));background:#fff;border-bottom:1px solid var(--line);
      position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:center;}
    .title{font-weight:600;font-size:calc(18px * var(--u));letter-spacing:.5px}
    .back{position:absolute;left:calc(12px * var(--u));width:calc(34px * var(--u));height:calc(34px * var(--u));
      border-radius:999px;display:grid;place-items:center;}
    .back svg{width:calc(18px * var(--u));height:calc(18px * var(--u));fill:#111}
    .capsule{position:absolute;right:calc(10px * var(--u));height:calc(30px * var(--u));
      padding:0 calc(10px * var(--u));border-radius:999px;background:#f6f7f9;border:1px solid #eef0f3;
      display:flex;align-items:center;gap:calc(10px * var(--u));}
    .dots{display:flex;gap:calc(4px * var(--u));}
    .dots span{width:calc(4px * var(--u));height:calc(4px * var(--u));border-radius:999px;background:#333;opacity:.65}
    .sep{width:1px;height:calc(16px * var(--u));background:#d7dbe2}
    .minus{width:calc(16px * var(--u));height:calc(16px * var(--u));border-radius:999px;border:1.6px solid rgba(0,0,0,.65);position:relative}
    .minus:after{content:"";position:absolute;left:calc(3px * var(--u));right:calc(3px * var(--u));top:calc(7px * var(--u));
      height:2px;background:rgba(0,0,0,.65)}

    .head{position:relative;height:calc(190px * var(--u));padding:calc(26px * var(--u)) calc(16px * var(--u)) 0;
      background:linear-gradient(180deg,var(--green1),var(--green2));overflow:hidden;}
    .head:before{content:"";position:absolute;left:calc(-140px * var(--u));top:calc(-80px * var(--u));
      width:calc(820px * var(--u));height:calc(320px * var(--u));
      background:repeating-linear-gradient(135deg,rgba(255,255,255,.18) 0px,rgba(255,255,255,.18) 10px,rgba(255,255,255,0) 10px,rgba(255,255,255,0) 24px);
      transform:rotate(-6deg);opacity:.35;}
    .head h1{position:relative;margin:calc(40px * var(--u)) 0 0;color:#fff;font-size:calc(28px * var(--u));
      font-weight:600;letter-spacing:.6px;}
    .seal{position:absolute;right:calc(14px * var(--u));top:calc(22px * var(--u));width:calc(110px * var(--u));
      height:calc(110px * var(--u));opacity:.30;pointer-events:none;}
    .seal img{width:100%;height:100%;object-fit:contain}

    .card{margin:calc(-38px * var(--u)) calc(12px * var(--u)) 0;background:var(--card);border-radius:var(--radius);
      box-shadow:var(--shadow);border:1px solid #f0f2f5;overflow:hidden;}
    .card + .card{margin-top:calc(14px * var(--u));}

    .info{padding:calc(16px * var(--u));display:flex;gap:calc(14px * var(--u));align-items:stretch;}
    .kv{flex:1;display:grid;grid-template-columns:calc(92px * var(--u)) 1fr;row-gap:calc(18px * var(--u));
      column-gap:calc(10px * var(--u));padding-top:calc(6px * var(--u));min-width:0;}
    .k{color:var(--muted);font-size:calc(20px * var(--u));}
    .v{color:#2a2f36;font-weight:600;font-size:calc(22px * var(--u));outline:none;white-space:nowrap;
      overflow:hidden;text-overflow:ellipsis;text-decoration:none;}
    .v, .money span{-webkit-text-fill-color:#2a2f36;}
    a{color:inherit;text-decoration:none}

    .photo{width:calc(118px * var(--u));height:calc(156px * var(--u));border-radius:calc(2px * var(--u));
      background:#e5e6e8;border:1px solid #dfe2e7;overflow:hidden;position:relative;flex:0 0 auto;}
    .photo img{width:100%;height:100%;object-fit:cover;display:none}
    .photo .hint{position:absolute;inset:0;display:grid;place-items:center;color:rgba(0,0,0,.45);font-size:calc(18px * var(--u));}
    .photo input{position:absolute;inset:0;opacity:0}

    .qrCard{padding:calc(18px * var(--u)) calc(14px * var(--u)) calc(16px * var(--u));text-align:center;}
    .qrBox{width:calc(318px * var(--u));height:calc(318px * var(--u));margin:calc(10px * var(--u)) auto calc(14px * var(--u));
      background:#fff;border-radius:calc(10px * var(--u));box-shadow:0 6px 18px rgba(0,0,0,.06);display:grid;place-items:center;cursor:pointer;}
    .qrBox canvas{width:calc(292px * var(--u));height:calc(292px * var(--u));image-rendering:pixelated;}
    .balance{display:flex;justify-content:center;gap:calc(14px * var(--u));font-size:calc(22px * var(--u));margin-top:calc(8px * var(--u));}
    .balance .muted{color:var(--muted);font-weight:600}
    .balance .money{font-weight:700}
    .money span{outline:none}

    .refresh{margin-top:calc(14px * var(--u));display:inline-flex;align-items:center;gap:calc(10px * var(--u));
      color:#b84b4b;font-size:calc(18px * var(--u));user-select:none;cursor:pointer;}
    .refresh svg{width:calc(18px * var(--u));height:calc(18px * var(--u));fill:#b84b4b}

    .section{margin:calc(18px * var(--u)) calc(12px * var(--u)) 0;display:flex;align-items:center;gap:calc(10px * var(--u));
      font-weight:700;color:#2a2f36;font-size:calc(22px * var(--u));}
    .bar{width:calc(4px * var(--u));height:calc(16px * var(--u));border-radius:calc(2px * var(--u));background:#c11f1f}

    .tabbar{position:fixed;left:0;right:0;bottom:0;height:calc(86px * var(--u));background:#fff;border-top:1px solid var(--line);
      display:flex;justify-content:space-around;align-items:flex-end;padding:calc(10px * var(--u)) 0 calc(10px * var(--u) + env(safe-area-inset-bottom));}
    .tab{width:calc(160px * var(--u));display:flex;flex-direction:column;align-items:center;gap:calc(6px * var(--u));color:#a2a7b0;font-size:calc(12px * var(--u));}
    .tab svg{width:calc(24px * var(--u));height:calc(24px * var(--u));fill:#a2a7b0}
    .tab.active{color:#6b6f77}
    .tab.active svg{fill:#6b6f77}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="back" aria-label="返回">
        <svg viewBox="0 0 24 24"><path d="M15.5 19a1 1 0 0 1-.7-.3l-6-6a1 1 0 0 1 0-1.4l6-6a1 1 0 1 1 1.4 1.4L11.9 12l4.3 4.3A1 1 0 0 1 15.5 19z"/></svg>
      </div>
      <div class="title">首页</div>
      <div class="capsule">
        <div class="dots"><span></span><span></span><span></span></div>
        <div class="sep"></div>
        <div class="minus"></div>
      </div>
    </div>

    <div class="head">
      <h1>电子校园卡</h1>
      <div class="seal"><img src="./seal_transparent.png" alt="校徽"/></div>
    </div>

    <div class="card">
      <div class="info">
        <div class="kv">
          <div class="k">姓名</div>
          <div class="v" id="name" contenteditable="true" spellcheck="false">丁子涵</div>

          <div class="k">工号</div>
          <div class="v" id="no" contenteditable="true" spellcheck="false">2453402065</div>

          <div class="k">人员类别</div>
          <div class="v" id="type" contenteditable="true" spellcheck="false">本科生</div>

          <div class="k">部门</div>
          <div class="v" id="dept" contenteditable="true" spellcheck="false">国际创新药学院</div>
        </div>

        <div class="photo">
          <img id="avatarImg" alt="头像"/>
          <div class="hint" id="avatarHint">照片</div>
          <input id="avatarInput" type="file" accept="image/*" />
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: calc(16px * var(--u));">
      <div class="qrCard">
        <div class="qrBox" id="qrBox" title="点击刷新二维码">
          <div id="qrMount"></div>
        </div>

        <div class="balance">
          <span class="muted">余额：</span>
          <span class="money">¥ <span id="bal" contenteditable="true" spellcheck="false">6.00</span></span>
        </div>

        <div class="refresh" id="refreshBtn">
          <svg viewBox="0 0 24 24"><path d="M12 6V3l-4 4 4 4V8c2.8 0 5 2.2 5 5a5 5 0 0 1-9.8 1H5.1A7 7 0 0 0 19 13c0-3.9-3.1-7-7-7z"/></svg>
          点击刷新
        </div>
      </div>
    </div>

    <div class="section"><span class="bar"></span><span>便捷生活</span></div>
    <div style="height: calc(180px * var(--u));"></div>
  </div>

  <div class="tabbar">
    <div class="tab active">
      <svg viewBox="0 0 24 24"><path d="M12 3 3 10v11h6v-7h6v7h6V10l-9-7z"/></svg>
      <div>首页</div>
    </div>
    <div class="tab">
      <svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.4 0-8 2.2-8 5v2h16v-2c0-2.8-3.6-5-8-5z"/></svg>
      <div>我的</div>
    </div>
  </div>

  <script>
/*! qrcode-generator (MIT) - simplified embed */
(function(global){
function QR8bitByte(data){this.mode=1;this.data=data;this.parsed=[];for(var i=0;i<this.data.length;i++){this.parsed.push(this.data.charCodeAt(i));}}
QR8bitByte.prototype={getLength:function(){return this.parsed.length;},write:function(buffer){for(var i=0;i<this.parsed.length;i++){buffer.put(this.parsed[i],8);}}};
function QRBitBuffer(){this.buffer=[];this.length=0;}
QRBitBuffer.prototype={get:function(i){var bufIndex=Math.floor(i/8);return((this.buffer[bufIndex]>>> (7-i%8))&1)==1;},
put:function(num,length){for(var i=0;i<length;i++){this.putBit(((num>>> (length-i-1))&1)==1);}},
putBit:function(bit){var bufIndex=Math.floor(this.length/8);if(this.buffer.length<=bufIndex){this.buffer.push(0);}
if(bit){this.buffer[bufIndex]|=(0x80>>> (this.length%8));}this.length++;}};
function QRPolynomial(num,shift){var offset=0;while(offset<num.length&&num[offset]==0)offset++;this.num=[];for(var i=0;i<num.length-offset;i++)this.num.push(num[i+offset]);for(i=0;i<shift;i++)this.num.push(0);}
QRPolynomial.prototype={get:function(i){return this.num[i];},getLength:function(){return this.num.length;},
multiply:function(e){var num=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<num.length;i++)num[i]=0;
for(i=0;i<this.getLength();i++){for(var j=0;j<e.getLength();j++){num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));}}
return new QRPolynomial(num,0);},
mod:function(e){if(this.getLength()-e.getLength()<0)return this;
var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));
var num=this.num.slice();for(var i=0;i<e.getLength();i++){num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);}
return new QRPolynomial(num,0).mod(e);}};
var QRMath={EXP_TABLE:new Array(256),LOG_TABLE:new Array(256),
glog:function(n){if(n<1)throw new Error("glog("+n+")");return this.LOG_TABLE[n];},
gexp:function(n){while(n<0)n+=255;while(n>=256)n-=255;return this.EXP_TABLE[n];}};
for(var i=0;i<8;i++)QRMath.EXP_TABLE[i]=1<<i;
for(i=8;i<256;i++)QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];
for(i=0;i<255;i++)QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;

var QRErrorCorrectLevel={L:1,M:0,Q:3,H:2};

function QRRSBlock(totalCount,dataCount){this.totalCount=totalCount;this.dataCount=dataCount;}
QRRSBlock.getRSBlocks=function(typeNumber,errorCorrectLevel){
var rsBlock=QRRSBlock.RS_BLOCK_TABLE[(typeNumber-1)*4+errorCorrectLevel];
if(!rsBlock)throw new Error("bad rs block");
var list=[];for(var i=0;i<rsBlock.length/3;i++){var count=rsBlock[i*3+0];var total=rsBlock[i*3+1];var data=rsBlock[i*3+2];
for(var j=0;j<count;j++)list.push(new QRRSBlock(total,data));}return list;};
QRRSBlock.RS_BLOCK_TABLE=[
[1,26,19],[1,26,16],[1,26,13],[1,26,9],
[1,44,34],[1,44,28],[1,44,22],[1,44,16],
[1,70,55],[1,70,44],[2,35,17],[2,35,13],
[1,100,80],[2,50,32],[2,50,24],[4,25,9]
];

function QRCodeModel(typeNumber,errorCorrectLevel){this.typeNumber=typeNumber;this.errorCorrectLevel=errorCorrectLevel;this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=[];}
QRCodeModel.prototype={
addData:function(data){this.dataList.push(new QR8bitByte(data));this.dataCache=null;},
isDark:function(r,c){return this.modules[r][c]===true;},
getModuleCount:function(){return this.moduleCount;},
make:function(){if(this.typeNumber<1){this.typeNumber=4;}this.makeImpl(false,this.getBestMaskPattern());},
makeImpl:function(test,maskPattern){
this.moduleCount=this.typeNumber*4+17;
this.modules=new Array(this.moduleCount);
for(var r=0;r<this.moduleCount;r++){this.modules[r]=new Array(this.moduleCount);for(var c=0;c<this.moduleCount;c++)this.modules[r][c]=null;}
this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);
this.setupTimingPattern();this.setupTypeInfo(test,maskPattern);
if(this.typeNumber>=2)this.setupPositionAdjustPattern();
if(this.dataCache==null)this.dataCache=QRCodeModel.createData(this.typeNumber,this.errorCorrectLevel,this.dataList);
this.mapData(this.dataCache,maskPattern);
},
setupPositionProbePattern:function(row,col){
for(var r=-1;r<=7;r++){if(row+r<=-1||this.moduleCount<=row+r)continue;
for(var c=-1;c<=7;c++){if(col+c<=-1||this.moduleCount<=col+c)continue;
if((0<=r&&r<=6&&(c==0||c==6))||(0<=c&&c<=6&&(r==0||r==6))||(2<=r&&r<=4&&2<=c&&c<=4))this.modules[row+r][col+c]=true;
else this.modules[row+r][col+c]=false;}}},
setupTimingPattern:function(){
for(var i=8;i<this.moduleCount-8;i++){
if(this.modules[i][6]==null)this.modules[i][6]=(i%2==0);
if(this.modules[6][i]==null)this.modules[6][i]=(i%2==0);
}},
setupPositionAdjustPattern:function(){
var pos=[6,26];
for(var i=0;i<pos.length;i++){for(var j=0;j<pos.length;j++){
var row=pos[i],col=pos[j];
if(this.modules[row][col]!=null)continue;
for(var r=-2;r<=2;r++){for(var c=-2;c<=2;c++){
this.modules[row+r][col+c]=(r==-2||r==2||c==-2||c==2||(r==0&&c==0));
}}}}
},
setupTypeInfo:function(test,maskPattern){
var data=(QRErrorCorrectLevel.M<<3)|maskPattern;
var bits=QRCodeModel.getBCHTypeInfo(data);
for(var i=0;i<15;i++){
var mod=!test&&((bits>>i)&1)==1;
if(i<6)this.modules[i][8]=mod;
else if(i<8)this.modules[i+1][8]=mod;
else this.modules[this.moduleCount-15+i][8]=mod;
if(i<8)this.modules[8][this.moduleCount-i-1]=mod;
else if(i<9)this.modules[8][15-i-1+1]=mod;
else this.modules[8][15-i-1]=mod;
}
this.modules[this.moduleCount-8][8]=!test;
},
getBestMaskPattern:function(){
var min=0,pattern=0;
for(var i=0;i<8;i++){this.makeImpl(true,i);var lost=QRCodeModel.getLostPoint(this);
if(i==0||min>lost){min=lost;pattern=i;}}
return pattern;
},
mapData:function(data,maskPattern){
var inc=-1,row=this.moduleCount-1,bitIndex=7,byteIndex=0;
for(var col=this.moduleCount-1;col>0;col-=2){
if(col==6)col--;
while(true){
for(var c=0;c<2;c++){
if(this.modules[row][col-c]==null){
var dark=false;
if(byteIndex<data.length)dark=((data[byteIndex]>>>bitIndex)&1)==1;
var mask=((row+col-c)%2==0); // good enough for look
this.modules[row][col-c]=mask? !dark: dark;
bitIndex--; if(bitIndex==-1){byteIndex++;bitIndex=7;}
}}
row+=inc;
if(row<0||this.moduleCount<=row){row-=inc;inc=-inc;break;}
}
}
},
};
QRCodeModel.PAD0=0xEC;QRCodeModel.PAD1=0x11;
QRCodeModel.createData=function(typeNumber,errorCorrectLevel,dataList){
var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,errorCorrectLevel);
var buffer=new QRBitBuffer();
for(var i=0;i<dataList.length;i++){
var data=dataList[i];
buffer.put(1,4);buffer.put(data.getLength(),8);data.write(buffer);
}
var totalDataCount=0;for(i=0;i<rsBlocks.length;i++)totalDataCount+=rsBlocks[i].dataCount;
if(buffer.length+4<=totalDataCount*8)buffer.put(0,4);
while(buffer.length%8!=0)buffer.putBit(false);
while(true){
if(buffer.length>=totalDataCount*8)break;
buffer.put(QRCodeModel.PAD0,8);
if(buffer.length>=totalDataCount*8)break;
buffer.put(QRCodeModel.PAD1,8);
}
return QRCodeModel.createBytes(buffer,rsBlocks);
};
QRCodeModel.createBytes=function(buffer,rsBlocks){
var offset=0,dcdata=[],ecdata=[],maxDc=0,maxEc=0;
for(var r=0;r<rsBlocks.length;r++){
var dcCount=rsBlocks[r].dataCount, ecCount=rsBlocks[r].totalCount-dcCount;
maxDc=Math.max(maxDc,dcCount);maxEc=Math.max(maxEc,ecCount);
dcdata[r]=new Array(dcCount);
for(var i=0;i<dcCount;i++)dcdata[r][i]=0xff & buffer.buffer[i+offset];
offset+=dcCount;
ecdata[r]=new Array(ecCount); for(i=0;i<ecCount;i++)ecdata[r][i]=0;
}
var total=0;for(r=0;r<rsBlocks.length;r++)total+=rsBlocks[r].totalCount;
var data=new Array(total), idx=0;
for(var i=0;i<maxDc;i++){for(r=0;r<rsBlocks.length;r++){if(i<dcdata[r].length)data[idx++]=dcdata[r][i];}}
for(i=0;i<maxEc;i++){for(r=0;r<rsBlocks.length;r++){if(i<ecdata[r].length)data[idx++]=ecdata[r][i];}}
return data;
};
QRCodeModel.getBCHTypeInfo=function(data){return data;};
QRCodeModel.getLostPoint=function(){return 0;};
function createQRCode(text,size){
var qr=new QRCodeModel(4,QRErrorCorrectLevel.M);
qr.addData(text);qr.make();
var count=qr.getModuleCount();
var canvas=document.createElement("canvas");
canvas.width=canvas.height=size;
var ctx=canvas.getContext("2d");
ctx.fillStyle="#fff";ctx.fillRect(0,0,size,size);
var tile=size/count;
ctx.fillStyle="#000";
for(var r=0;r<count;r++){for(var c=0;c<count;c++){
if(qr.isDark(r,c))ctx.fillRect(Math.round(c*tile),Math.round(r*tile),Math.ceil(tile),Math.ceil(tile));
}}
return canvas;
}
global.__createQRCodeCanvas=createQRCode;
})(window);

  </script>
  <script>
    const avatarImg = document.getElementById("avatarImg");
    const avatarHint = document.getElementById("avatarHint");
    document.getElementById("avatarInput").addEventListener("change", (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        avatarImg.src = reader.result;
        avatarImg.style.display="block";
        avatarHint.style.display="none";
      };
      reader.readAsDataURL(f);
    });

    function payload(){
      return JSON.stringify({
        name: (document.getElementById("name").innerText||"").trim(),
        no:   (document.getElementById("no").innerText||"").trim(),
        type: (document.getElementById("type").innerText||"").trim(),
        dept: (document.getElementById("dept").innerText||"").trim(),
        bal:  (document.getElementById("bal").innerText||"").trim(),
        t: Date.now()
      });
    }

    function renderQR(){
      const mount = document.getElementById("qrMount");
      mount.innerHTML = "";
      const u = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--u')) || 1;
      const size = Math.round(292 * u);
      mount.appendChild(window.__createQRCodeCanvas(payload(), size));
    }

    document.getElementById("refreshBtn").addEventListener("click", renderQR);
    document.getElementById("qrBox").addEventListener("click", renderQR);
    ["name","no","type","dept","bal"].forEach(id=>{
      document.getElementById(id).addEventListener("blur", renderQR);
    });

    renderQR();
  </script>
</body>
</html>
